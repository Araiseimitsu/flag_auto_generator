## 更新履歴

### 2025-12-12

- Tkinter アプリ内で設定JSONを作成/編集/保存/読込できる `ConfigEditor` を追加。
- UIから直接、元xlsxを選択して数式生成・保存が可能に。

### 2025-12-15

- `excel_test.py` のインデント崩れを修正し、`build_request_formulas()` が正しく保存まで到達するように整理。
- Excel保存を原子的（tmp→replace）にし、出力先ファイルがロックされている場合は「再試行/中止」でユーザーに閉じ操作を促す（誤って別ファイルを開く事故を防止）。
- 出力列を `I`〜`SN` に固定し、各列の1行目に `SUMPRODUCT` の集計式を自動投入（範囲は `summary_row_min..summary_row_max`、行ステップは `summary_row_step`）。
- `SUMPRODUCT` 集計式は読みやすい複数行フォーマット（改行付き）で書き込むよう調整。
- 測定行(min)のデフォルトを `9` に変更。
- 設定JSONの保存/読み込みボタンを削除。
- 起動時に画面を最大化。
- 初期の工具サンプルは「前挽き」1件、測定Noは `1` のみに変更。

### 2025-12-16

- UIテーマを `ttkbootstrap` のダーク系テーマに切替え、Tk標準スタイル依存を解消。
- 「元Excelとプレビュー」セクションを追加し、先にExcelを読み込んで対象シートの先頭行をプレビュー確認可能にした。
- 測定不要書き込み設定を基本設定の右カラムに移動し、フォームを横並びで扱いやすく整理。
- 依存ライブラリに `ttkbootstrap` を追加（requirements.txt）。

### 2026-02-26

- Excel出力後に `pywin32` 経由でExcel本体を非表示起動し、`CalculateFullRebuild` 実行後に再保存する処理を追加。
- openpyxl保存後に一部数式が初回表示されないケース（セルをアクティブ化すると表示される症状）を回避するため、`build_request_formulas()` と `write_measurement_not_required()` の保存フローに強制再計算を組み込んだ。
- B列で単一セル配列数式として保持されていた既存式を、出力時に通常数式へ正規化する処理を追加（対象行: 測定行範囲）。
- E列の文言書き込み判定を調整し、セルに数式が入っていても表示結果が空文字なら空欄扱いで上書きするよう修正。
- E列の文言書き込み判定をさらに調整し、対象セルが数式セルの場合は表示キャッシュに関わらず文言を上書きするよう修正。
- Excel強制再計算前にopenpyxlで開いているワークブックを明示的にクローズし、COMの `Workbooks.Open` をリトライ付きで実行するよう修正（保存直後のファイルロック対策）。
- E列の文言（工具名・230行案内・測定不要）は条件判定を廃止し、常に上書きする動作に変更。
- Excel COM再計算に失敗しても出力ファイルは有効であるため、ログを非致命のスキップ通知に変更。
- 測定不要の `L～SR` 設定で、既存数式セルは上書き対象に含めるよう修正し、`197行目` 判定式を `LEN(TRIM(...))` ベースに変更して空文字・空白混在時の判定漏れを防止。
- A列の測定Noが数式でキャッシュ値未計算の場合、行位置（開始行・ステップ）から測定Noを解決するフォールバックを追加し、`指定したNoの行が見つからない` 警告を回避。
- A列が数式文字列の場合は数値抽出より先に行位置ベースで測定Noを解決するよう順序を修正し、`11,14,17...` への誤解釈を防止。
- 生成後のExcel再計算処理で `Workbooks.Open` に `CorruptLoad=1`（修復モード）を優先適用し、`externalLink`/`drawing` 由来の修復ダイアログ発生を抑制。
- openpyxl読み込み時に `keep_links=False` を適用し、外部リンク情報（externalLinks）の出力持ち越しを抑制。
- Excel COM側の保存処理を `SaveAs(FileFormat=51)` 優先に変更し、出力ファイルの内部構造を再構築して修復ログ発生を抑制。
- openpyxl保存後に、元テンプレートの `xl/drawings/*` と `xl/externalLinks/*` パーツを出力ファイルへ復元コピーする処理を追加し、修復ログ（drawing/externalLinks）の発生抑制を強化。
- UIの「ヘルプ」内容を最新仕様に更新し、自動測定結果反映・測定不要書き込み・Excel生成時の処理順が分かるように整理。
- `README.md` を新規作成し、セットアップ手順・実行方法・必要環境変数（なし）を明記。
